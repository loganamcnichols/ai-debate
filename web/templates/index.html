<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Debate</title>
  <link rel="stylesheet" href="static/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@2.0.2/dist/htmx.js" integrity="sha384-yZq+5izaUBKcRgFbxgkRYwpHhHHCpp5nseXp0MEQ1A4MTWVMnqkmcuFez8x5qfxr" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
  <script src="static/js/sse.min.js" defer></script>
  <script src="https://unpkg.com/hyperscript.org@0.9.12" defer></script>
</head>
<body>
  <main _="on load 
           on scroll 
            if my scrollTop + my clientHeight is greater than my scrollHeight - 100 
              set userScrolling to true
            otherwise 
              set userScrolling to false
            end
           on htmx:sseMessage 
            if no userScrolling set my scrollTop to my scrollHeight 
            end
           on htmx:sseClose send wakeUp to #user-input
           on htmx:afterSettle set my scrollTop to my scrollHeight">
  <header id="sticky-header">
      <div id="countdown-timer">
          <p>Survey in &nbsp;&nbsp;<span id="timer"><span id="minutes">05</span><span>:</span><span id="seconds">00</span></span></p>
      </div>
      <div id="new-chat-btn"
           _="on click call deleteCookie('response-id')
                  then call deleteCookie('timerValue')"><a href="/">New Chat</a></div>
  </header>
    {{ if eq (len .QuestionRows) 0 }}
    <div class="chat-row"
         _="on load showIntroMsgs()
               then showBotIntros()"></div>
      <p id="intro-msg-one" class="intro-msg">
        You will have the opportunity for the next 5 minutes to engage in a discussion with two LLMs.
      </p>
      <p id="intro-msg-two" class="intro-msg">
        One is trained on the strongest arguments for to prioritize greater <strong>caution</strong> in AI developement
      </p>
      <p id="intro-msg-three" class="intro-msg">
        The other is trained on the strongest arguments to prioritize greater <strong>innovation</strong> in AI developement.
      </p>
      <div class="response-left"></div>
      <div class="response-right"></div>
  {{ else }}
  {{ range $i, $val := .QuestionRows }}
  {{ if eq (mod $i 2) 0 }}
    <div class="chat-row">
      <p class="user-msg">{{ .UserMsg }}</p>
      <div class="response-left">{{ .FirstResponse }}</div>
      <div class="response-right">{{ .SecondResponse }}</div>
    </div>
  {{ else }}
    <div class="chat-row">
      <p class="user-msg">{{ .UserMsg }}</p>
      <div class="response-left">{{ .FirstResponse }}</div>
      <div class="response-right">{{ .SecondResponse }}</div>
    </div>
  {{ end }}
  {{ end }}
  {{ end }}
    <form id="submission-form" hx-post="/submit-question?response-id={{ .ResponseID }}&orientation={{ .Orientation }}"
          hx-trigger="keydown[key==='Enter'&&!shiftKey], submit" hx-swap="outerHTML show:bottom">
      <div class="textbar">
        <textarea name="user-msg" id="user-input" rows="1" 
        _="on keydown[key is 'Enter' and no shiftkey] halt the event's default 
            on input set my *height to my scrollHeight px
            on wakeUp remove @disabled"></textarea>
        <button type="submit">
          <img src="static/images/send.svg">
        </button>
      </div>
    </form>
  </main>

<script type="text/hyperscript">
  def animateAppend(elt, x)
    log 'got here'
    log elt's innerHTML
    repeat for word in x.split(' ')
      log 'looping'
      wait 100ms append word + ' ' to elt's innerHTML
    end
  end

  def showIntroMsgs()
    get .intro-msg then
    repeat for msg in it
      add .visible to msg
      wait 2s
    end
  end

  def showBotIntros()
  {{ if .InnovationFirst }}
    set first_msg to "I will be arguing for greater <strong>innovation</strong>..."
    set second_msg to "and I will be arguing for greater <strong>caution</strong>."
  {{ else }}
    set first_msg to "I will be arguing for greater <strong>caution</strong>..."
    set second_msg to "and I will be arguing for greater <strong>innovation</strong>."
  {{ end }}
    log 'first message'
    get the first .response-left then
    call animateAppend(it, first_msg)
    wait 200ms
    get the first .response-right then
    call animateAppend(it, second_msg)
  end
    

</script>
<script type="text/hyperscript">
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
      const COOKIE_NAME = "timerEndTime";
      const TOTAL_TIME = 5 * 60; // 5 minutes in seconds

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }

      function setCookie(name, value, expirationInSeconds) {
        const date = new Date();
        date.setTime(date.getTime() + (expirationInSeconds * 1000));
        const expires = "expires=" + date.toUTCString();
        document.cookie = `${name}=${value};${expires};path=/`;
      }

      // Initialize or retrieve the end time
      let endTime = getCookie(COOKIE_NAME);
      if (!endTime) {
        const now = Date.now();
        endTime = now + TOTAL_TIME * 1000;
        setCookie(COOKIE_NAME, endTime, TOTAL_TIME);
      } else {
        endTime = parseInt(endTime, 10);
      }

      const minutesSpan = document.getElementById("minutes");
      const secondsSpan = document.getElementById("seconds");

      const timerInterval = setInterval(updateTimer, 1000);
      updateTimer(); // Initialize immediately

      function updateTimer() {
        const now = Date.now();
        let timeRemaining = Math.floor((endTime - now) / 1000);

        if (timeRemaining < 0) timeRemaining = 0;

        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;

        minutesSpan.textContent = String(minutes).padStart(2, '0');
        secondsSpan.textContent = String(seconds).padStart(2, '0');

        if (timeRemaining > 0) {
          // Optionally, update the cookie to extend the expiration
          setCookie(COOKIE_NAME, endTime, timeRemaining);
        } else {
          clearInterval(timerInterval);
          // Redirect to the /survey page
          window.location.href = "/survey";
          // Optionally, clear the cookie
          setCookie(COOKIE_NAME, "", -1);
        }
      }
    });
function deleteCookie(name) {
  console.log('delete cookie called');
  document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
}
</script>

</body>
</html>