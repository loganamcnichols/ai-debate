<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Debate</title>
  <link rel="stylesheet" href="static/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@2.0.2/dist/htmx.js" integrity="sha384-yZq+5izaUBKcRgFbxgkRYwpHhHHCpp5nseXp0MEQ1A4MTWVMnqkmcuFez8x5qfxr" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
  <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
  <script src="https://unpkg.com/hyperscript.org@0.9.12" defer></script>
</head>
<body>
  <main  _="on load get last in me
              then it.scrollIntoView({ behavior: 'smooth', block: 'end' })
            on opening call sendMessageToParent('user-input', 'Opening argument')"
          hx-post="/submit-question?response-id={{ .ResponseID }}"
          hx-vals='{ "user-msg": "Opening argument" }'
          hx-swap="beforeend"
          hx-trigger="opening">
  {{ if eq (len .QuestionRows) 0 }}
    <div class="intro-msgs">
      <p class="intro-msg" _="on load wait 1s
                              add .visible to me
                              then send show to the next <p/>">
        You will have the opportunity for the next 5 minutes to engage in a discussion with two LLMs.
      </p>
      <p class="intro-msg" _="on show wait 2s
                              add .visible to me 
                              then send show to the next <p/>">
        one will make the strongest arguments for to prioritize greater <strong>caution</strong> in AI development.
      </p>
      <p class="intro-msg" _="on show wait 2s
                              add .visible to me 
                              then wait 3s trigger opening on <main/>">
        The other will make the strongest arguments to prioritize greater <strong>innovation</strong> in AI development.
      </p>
    </div>
  {{ else }}
  {{ range $i, $val := .QuestionRows }}
    <div class="chat-row">
      <div class="msg">{{ .UserMsg }}</div>
      <div class="msg">{{ .FirstResponse }}</div>
      <div class="msg">{{ .SecondResponse }}</div>
    </div>
  {{ end }}
  {{ end }}
  </main>
  <footer>
    <form id="suggestion-form" hx-post="/submit-question?response-id={{ .ResponseID }}"
          hx-swap="beforeend" hx-target="main"
          hx-trigger="submit"
           _="on htmx:beforeRequest 
                add @disabled to <#prompt-button,#input-button,#user-input/> then
                call sendMessageToParent('user-input', #prompt-button.value)
              on htmx:afterSwap from me 
                get the last .chat-row in event.detail.target then
                it.scrollIntoView({ block: 'end', behavior: 'smooth' })"> 
      <button id="prompt-button" type="submit" hx-trigger="every 5s, load consume" 
              hx-get="prompt-suggestion" hx-target="this" hx-swap="innerHTML"
              {{ if eq (len .QuestionRows) 0 }}disabled{{ end }}
              _="on htmx:beforeRequest halt the event's bubbling
                 on htmx:afterRequest halt the event's bubbling
                 on htmx:afterSwap halt the event's bubbling"></button>
    </form>
    <form id="submission-form" hx-post="/submit-question?response-id={{ .ResponseID }}"
          hx-trigger="keydown[key==='Enter'&&!shiftKey], submit, opening" 
          hx-swap="beforeend" hx-target="main"
           _="on htmx:beforeRequest get #user-input then 
                if its value equals '' 
                  halt the event 
                else 
                  call sendMessageToParent('user-input', #user-input.value) then
                  add @disabled to <#prompt-button,#input-button,#user-input/>
                end
              on htmx:afterRequest
                set #user-input's value to ''
              on htmx:afterSwap
                get the last .chat-row in event.detail.target then
                it.scrollIntoView({ block: 'end', behavior: 'smooth' })">
      <div class="textbar">
        <textarea name="user-msg" id="user-input" rows="1" value="Opening arguments"
        _="on keydown[key is 'Enter' and no shiftkey] halt the event's default 
           on input set my *height to my scrollHeight px" {{ if eq (len .QuestionRows) 0 }}disabled{{ end }}></textarea>
        <button id="input-button" type="submit" {{ if eq (len .QuestionRows) 0 }}disabled{{ end }}>
          <img src="static/images/send.svg">
        </button>
      </div>
    </form>
  </footer>
<script>

  let innovationFirst = true;
  const allowedOrigins = [
    'http://localhost:5173',
    'https://surveyor.ink',
    'https://www.surveyor.ink'
  ];
  function isInIframe() {
    try {
      return window.self !== window.top;
    } catch (e) {
      return true;
    }
  }

  // Function to send message to parent
  function sendMessageToParent(type, content) {
    if (!isInIframe()) {
      return;
    }
    allowedOrigins.forEach(origin => {
      try {
        window.parent.postMessage({ type, content }, origin);
      } catch (e) {
        console.error('Error sending message to', origin, ':', e);
      }
    });

    function openingArguments() {

    } 
  }

  // Modified response event handler
  function responseEvent(event) {
    const msg = event.detail;
    if (msg.type == "innovation-first") {
      if (msg.data == "true") innovationFirst = true; 
      else if (msg.data == "false") innovationFirst = false;
      else throw("unknown messaged data");
      event.preventDefault();
    }
    if (msg.type === "first-response") {
      if (innovationFirst) sendMessageToParent('innovation-response', msg.data);
      else                 sendMessageToParent('caution-response', msg.data);
    } else if (msg.type === "second-response") {
      if (innovationFirst) sendMessageToParent('caution-response', msg.data);
      else                 sendMessageToParent('innovation-response', msg.data);
    }
  }
</script>
</body>
</html>