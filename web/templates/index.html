<!DOCTYPE html>
<head>
  <title>AI Debate</title>
  <link rel="stylesheet" href="static/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@2.0.2/dist/htmx.js" integrity="sha384-yZq+5izaUBKcRgFbxgkRYwpHhHHCpp5nseXp0MEQ1A4MTWVMnqkmcuFez8x5qfxr" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
  <script src="https://unpkg.com/hyperscript.org@0.9.12" defer></script>
</head>

<body>
  <div class="chat-area">
    {{ range $i, $val := .QuestionRows }}
      <div class="user"></div>
      {{ if or (and (eq (mod $i 2) 0) $.InnovationFirst) (and (ne (mod $i 2) 0) (not $.InnovationFirst)) }}
        <div class="response-left">{{ $val.InnovationMsg }}</div>
        <div class="response-right response-2">{{ $val.CautionMsg }}</div>
      {{ else }}
        <div class="response-right">{{ $val.CautionMsg }}</div>
        <div class="response-left">{{ $val.InnovationMsg }}</div>
      {{ end }}
    {{ end }}
  </div>
  {{ if and (eq (mod (len .QuestionRows) 2) 0) .InnovationFirst }}
    <form id="submission-form" hx-post="/submit-question?response-id={{ .ResponseID }}&orientation=left"
          hx-post="/submit" hx-trigger="keydown[key==='Enter'&&!shiftKey], submit" hx-target=".chat-area" hx-swap="beforeend">
      <div class="textbar">
        <textarea name="user-msg" rows="1" 
        _="on keydown[key is 'Enter' and no shiftkey] halt the event's default wait for 100ms set me.disabled to true
           on input set my *height to my scrollHeight px"></textarea>
      </div>
    </form>
  {{ else }}
    <form id="submission-form" hx-post="/submit-question?response-id={{ .ResponseID }}&orientation=right"
          hx-post="/submit" hx-trigger="keydown[key==='Enter'&&!shiftKey], submit" hx-target=".chat-area" hx-swap="beforeend">
      <div class="textbar">
        <textarea name="user-msg" id="user-input" rows="1" 
        _="on keydown[key is 'Enter' and no shiftkey] halt the event's default 
           wait for 100ms 
           set my.disabled to true
           on input set my *height to my scrollHeight px"></textarea>
      </div>
    </form>
  {{ end }}
<script>
  function scrollToBottom() {
    chatArea.scrollTop = chatArea.scrollHeight;
  }
  // Select the chat area element
  const chatArea = document.querySelector('.chat-area');

  // Variable to track if the user is scrolling up
  let isUserScrollingUp = false;

  // Event listener to detect user scroll
  chatArea.addEventListener('scroll', () => {
    const threshold = 100; // Pixels from the bottom to consider as "near the bottom"
    const position = chatArea.scrollTop + chatArea.clientHeight;
    const height = chatArea.scrollHeight;

    if (position >= height - threshold) {
      isUserScrollingUp = false;
    } else {
      isUserScrollingUp = true;
    }
  });
  // Listen for the htmx:sseMessage event
  document.body.addEventListener('htmx:sseClose', function(event){
    console.log("got here");
    textarea = document.getElementById("user-input");
    form = document.getElementById("submission-form");
    textarea.disabled = false;

    // Get the current hx-post value
    let hxPostValue = form.getAttribute('hx-post');

    // Parse the URL and its parameters
    let url = new URL(hxPostValue, 'http://example.com');
    let params = new URLSearchParams(url.search);

    // Change the orientation parameter to 'left'
    if (params.get('orientation') == 'left') {
      console.log("swapping orientation");
      params.set('orientation', 'right');
    } else {
      console.log("swapping orientation");
      params.set('orientation', 'left');
    }

    // Reconstruct the URL with the updated parameters
    url.search = params.toString();

    // Update the hx-post attribute, removing the base URL we added
    form.setAttribute('hx-post', url.pathname + url.search);
  })

  document.body.addEventListener('htmx:sseMessage', (event) => {
    if (!isUserScrollingUp) {
      scrollToBottom();
    }
  });
</script>
</body>